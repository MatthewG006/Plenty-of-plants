(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[976],{8564:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>D});var a=s(5155),n=s(2115),r=s(3998),l=s(6948),i=s(5740),o=s(8854),c=s(9347),d=s(5299),u=s(7801),m=s(5626),x=s(9559),h=s(1169),f=s(6613),p=s(5239),j=s(5894),v=s(4269),N=s(9689),b=s(4901),w=s(926);let g=(0,w.createServerReference)("60b6c56b0e23a3987ee19f8431fc5635b22e11088d",w.callServer,void 0,w.findSourceMapURL,"sendHeartbeat"),y=(0,w.createServerReference)("402da768e7a41e8682ec7fcd10fc2d1efbae22aa75",w.callServer,void 0,w.findSourceMapURL,"processContestState"),S=(0,w.createServerReference)("78ef475e9e106756b988199bd95fc296a0343cee24",w.callServer,void 0,w.findSourceMapURL,"joinContest"),C=(0,w.createServerReference)("70f2627d27e17bbaac379e1b07880dda3750059970",w.callServer,void 0,w.findSourceMapURL,"voteForContestant");var A=s(2619),R=s.n(A),E=s(9708),M=s(4585),I=s(1708),V=s(5584),k=s(63);let T=[{top:"20%",left:"15%"},{top:"20%",left:"65%"},{top:"55%",left:"15%"},{top:"55%",left:"65%"}];function W(){return(0,a.jsx)("div",{className:"absolute inset-0 pointer-events-none z-20 overflow-hidden",children:Array.from({length:7}).map((e,t)=>(0,a.jsx)(i.A,{className:"absolute text-yellow-300 animate-sparkle",style:{top:"".concat(100*Math.random(),"%"),left:"".concat(100*Math.random(),"%"),animationDelay:"".concat(1.5*Math.random(),"s"),width:"".concat(5+5*Math.random(),"px"),height:"".concat(5+5*Math.random(),"px")}},t))})}function Z(e){let{contestant:t,onVote:s,hasVoted:n,isWinner:i}=e;return(0,a.jsxs)(l.Zp,{className:(0,v.cn)("text-center transition-all relative overflow-hidden",i&&"border-yellow-400 border-2 shadow-yellow-300/50 shadow-lg"),children:[i&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"absolute top-2 right-2 text-yellow-400 z-10",children:(0,a.jsx)(o.A,{className:"w-8 h-8",fill:"currentColor"})}),(0,a.jsx)(W,{})]}),(0,a.jsxs)(l.Wu,{className:"p-2",children:[(0,a.jsx)("div",{className:"aspect-square rounded-md bg-muted/50 mb-2 relative",children:(0,a.jsx)(p.default,{src:t.image,alt:t.name,fill:!0,sizes:"150px",className:"object-cover"})}),(0,a.jsx)("h3",{className:"font-bold text-primary truncate",children:t.name}),(0,a.jsxs)("p",{className:"text-xs text-muted-foreground truncate",children:["by ",t.ownerName]}),(0,a.jsxs)("div",{className:"flex items-center justify-center gap-1.5 mt-1 text-muted-foreground",children:[(0,a.jsx)(c.A,{className:(0,v.cn)("w-4 h-4",t.votes>0&&"text-yellow-500 fill-current")}),(0,a.jsx)("span",{className:"text-sm font-medium",children:t.votes})]}),(0,a.jsx)(r.$,{onClick:()=>s(t.id),size:"sm",className:"w-full mt-2",disabled:n,children:n?"Voted":"Vote"})]})]})}function D(){let{user:e,gameData:t}=(0,b.A)(),{toast:s}=(0,j.dj)(),{playSfx:i}=(0,N.n)(),o=(0,k.useRouter)(),c=(0,k.useParams)().sessionId,[v,w]=(0,n.useState)(!0),[A,W]=(0,n.useState)(null),[D,O]=(0,n.useState)(null),[z,F]=(0,n.useState)([]),[P,_]=(0,n.useState)(!1),[B,L]=(0,n.useState)(!1),[Y,$]=(0,n.useState)(0),U=e&&z.some(t=>t.ownerId===e.uid),q=e&&z.some(t=>{var s;return null==(s=t.voterIds)?void 0:s.includes(e.uid)});(0,n.useEffect)(()=>{if(e&&U&&(null==D?void 0:D.status)==="waiting"&&c){let t=setInterval(()=>{g(c,e.uid)},1e4);return g(c,e.uid),()=>clearInterval(t)}},[e,U,null==D?void 0:D.status,c]),(0,n.useEffect)(()=>{let e;if(!D||"finished"===D.status)return;let t=()=>{if(D.expiresAt){let e=Math.max(0,Math.floor((new Date(D.expiresAt).getTime()-Date.now())/1e3));$(e),e<=0&&y(c)}};return t(),e=setInterval(t,1e3),()=>clearInterval(e)},[D,c]),(0,n.useEffect)(()=>{(null==D?void 0:D.status)==="finished"&&D.winner&&(0,I.A)({particleCount:150,spread:180,origin:{y:.6}})},[null==D?void 0:D.status,null==D?void 0:D.winner]),(0,n.useEffect)(()=>{if(!e||!c)return void w(!1);w(!0);let t=(0,E.aQ)((0,E.H9)(M.db,"contestSessions",c),e=>{if(e.exists()){var t,s;let a=e.data();O({id:e.id,...a,createdAt:(null==(t=a.createdAt)?void 0:t.toDate)?a.createdAt.toDate().toISOString():a.createdAt,expiresAt:(null==(s=a.expiresAt)?void 0:s.toDate)?a.expiresAt.toDate().toISOString():a.expiresAt,winner:a.winner})}else O(null),W("This contest lobby no longer exists.");w(!1)},e=>{console.error("Snapshot error:",e),W("Could not connect to the contest service."),w(!1)}),s=(0,E.aQ)((0,E.rJ)(M.db,"contestSessions",c,"contestants"),e=>{F(e.docs.map(e=>({id:e.id,...e.data()})))});return()=>{t(),s()}},[e,c]),(0,n.useEffect)(()=>{if(A){let e=setTimeout(()=>{o.push("/community/contest")},3e3);return()=>clearTimeout(e)}},[A,o]);let H=async t=>{if(e&&e.displayName){_(!1),L(!0),W(null);try{let{success:a,error:n}=await S(c,e.uid,e.displayName,t);if(n)throw Error(n);a&&s({title:"You have entered the contest!"})}catch(e){console.error("Failed to join contest:",e),W(e.message||"Failed to join the contest."),s({variant:"destructive",title:"Contest Error",description:e.message})}finally{L(!1)}}},J=async t=>{if(e&&D&&c)try{i("tap"),await C(c,e.uid,t),s({title:"Vote Cast!",description:"Your vote has been counted."})}catch(e){console.error(e),s({variant:"destructive",title:"Voting Error",description:e.message})}};return v||B?(0,a.jsxs)("div",{className:"flex h-screen w-full items-center justify-center",children:[(0,a.jsx)(d.A,{className:"h-8 w-8 animate-spin text-primary"}),(0,a.jsx)("p",{className:"ml-2",children:B?"Joining contest...":"Finding contest..."})]}):A||!D?(0,a.jsxs)(l.Zp,{className:"m-4 text-center py-10 border-destructive",children:[(0,a.jsxs)(l.aR,{children:[(0,a.jsx)("div",{className:"mx-auto bg-destructive/10 rounded-full w-fit p-3 mb-2",children:(0,a.jsx)(u.A,{className:"h-10 w-10 text-destructive"})}),(0,a.jsx)(l.ZB,{className:"text-destructive",children:"Contest Error"}),(0,a.jsxs)(l.BT,{children:[A||"The contest session could not be found.",(0,a.jsx)("br",{}),"You will be returned to the lobby list shortly."]})]}),(0,a.jsx)(l.Wu,{children:(0,a.jsx)(d.A,{className:"h-6 w-6 animate-spin text-destructive mx-auto"})})]}):(0,a.jsxs)("div",{className:"p-4 space-y-4 pb-20",children:[(0,a.jsxs)("header",{className:"flex items-center justify-between pb-2",children:[(0,a.jsx)(r.$,{asChild:!0,variant:"ghost",size:"icon",children:(0,a.jsx)(R(),{href:"/community/contest",children:(0,a.jsx)(m.A,{})})}),(0,a.jsx)("h1",{className:"text-2xl text-primary font-bold text-center",children:"Plant Beauty Contest"}),(0,a.jsx)("div",{className:"w-10"})]}),(0,a.jsxs)(l.Zp,{className:"text-center p-4 bg-muted/50",children:[(0,a.jsxs)("h2",{className:"text-lg font-semibold text-primary",children:["Round ",D.round]}),(0,a.jsxs)("p",{className:"text-sm text-muted-foreground",children:["waiting"===D.status&&"Waiting for players... (".concat(D.contestantCount,"/").concat(T.length,")"),"voting"===D.status&&"Vote for your favorite!","finished"===D.status&&"Contest Over!"]}),(0,a.jsxs)("div",{className:"text-3xl font-bold text-primary mt-1",children:[Y,"s"]})]}),"waiting"===D.status&&Y<=0&&D.contestantCount<2&&(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("p",{className:"text-sm text-muted-foreground mb-2",children:"The lobby timer has expired."}),(0,a.jsxs)(r.$,{onClick:()=>window.location.reload(),children:[(0,a.jsx)(x.A,{className:"mr-2 h-4 w-4"}),"Refresh Status"]})]}),"waiting"===D.status&&(0,a.jsxs)(l.Zp,{className:"relative min-h-[400px]",children:[(0,a.jsx)(l.aR,{children:(0,a.jsxs)(l.ZB,{className:"flex items-center gap-2",children:[(0,a.jsx)(h.A,{})," Contest Lobby"]})}),(0,a.jsxs)(l.Wu,{children:[(0,a.jsx)("div",{className:"absolute inset-0",children:z.map((t,s)=>{let n=T[s%T.length];return(0,a.jsxs)("div",{className:"absolute w-1/4",style:{top:n.top,left:n.left},children:[(0,a.jsx)("div",{className:"relative aspect-square",children:(0,a.jsx)(p.default,{src:t.image,alt:t.name,fill:!0,sizes:"100px",className:"object-contain"})}),(0,a.jsxs)("p",{className:"text-center text-xs font-bold text-primary truncate",children:[t.ownerName,t.ownerId===(null==e?void 0:e.uid)&&(0,a.jsx)("span",{className:"text-muted-foreground",children:" (You)"})]})]},t.id)})}),(0,a.jsx)("div",{className:"absolute bottom-4 left-4 right-4",children:!U&&Y>0&&D.contestantCount<T.length?(0,a.jsxs)(r.$,{className:"w-full",onClick:()=>_(!0),children:[(0,a.jsx)(f.A,{className:"mr-2"}),"Enter Your Plant!"]}):null})]})]}),"voting"===D.status&&(0,a.jsx)("div",{className:"grid grid-cols-2 gap-4",children:z.map(e=>(0,a.jsx)(Z,{contestant:e,onVote:J,hasVoted:!!q,isWinner:!1},e.id))}),"finished"===D.status&&D.winner&&(0,a.jsxs)(l.Zp,{children:[(0,a.jsx)(l.aR,{className:"items-center",children:(0,a.jsx)(l.ZB,{className:"text-2xl text-yellow-500",children:"We have a winner!"})}),(0,a.jsxs)(l.Wu,{children:[(0,a.jsx)(Z,{contestant:D.winner,onVote:()=>{},hasVoted:!0,isWinner:!0}),(0,a.jsxs)("div",{className:"text-center mt-4 space-y-2",children:[(0,a.jsxs)("p",{children:["Congratulations to ",(0,a.jsx)("span",{className:"font-bold text-primary",children:D.winner.ownerName}),"!"]}),(0,a.jsx)("p",{className:"text-muted-foreground text-sm",children:"They have been awarded 50 gold and a special Red Glitter cosmetic!"}),(0,a.jsx)(r.$,{asChild:!0,className:"mt-4",children:(0,a.jsx)(R(),{href:"/community/contest",children:"Find a New Contest"})})]})]})]}),(0,a.jsx)(V.ir,{open:P,onOpenChange:_,allPlants:Object.values((null==t?void 0:t.plants)||{}),onSelectPlant:H})]})}},9441:(e,t,s)=>{Promise.resolve().then(s.bind(s,8564))}},e=>{e.O(0,[992,416,760,7,967,619,476,667,806,654,184,482,584,441,255,358],()=>e(e.s=9441)),_N_E=e.O()}]);