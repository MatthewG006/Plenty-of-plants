(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[327],{506:(e,t,a)=>{Promise.resolve().then(a.bind(a,5103))},5103:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>_});var l=a(5155),n=a(2115),s=a(6948),r=a(5740),i=a(1503),o=a(5299),d=a(9347),c=a(5239),m=a(5894),u=a(4269),p=a(4521),h=a(4901),x=a(9285),f=a(8138),g=a(233),j=a(926);let v=(0,j.createServerReference)("4008f677d2d33f6493d32843143ee07d7577dea864",j.callServer,void 0,j.findSourceMapURL,"evolvePlantAction");var w=a(4577),b=a(4033),y=a(2108),N=a(5917);let C=w.bL;w.YJ;let M=w.WT,k=n.forwardRef((e,t)=>{let{className:a,children:n,...s}=e;return(0,l.jsxs)(w.l9,{ref:t,className:(0,u.cn)("flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",a),...s,children:[n,(0,l.jsx)(w.In,{asChild:!0,children:(0,l.jsx)(b.A,{className:"h-4 w-4 opacity-50"})})]})});k.displayName=w.l9.displayName;let I=n.forwardRef((e,t)=>{let{className:a,...n}=e;return(0,l.jsx)(w.PP,{ref:t,className:(0,u.cn)("flex cursor-default items-center justify-center py-1",a),...n,children:(0,l.jsx)(y.A,{className:"h-4 w-4"})})});I.displayName=w.PP.displayName;let S=n.forwardRef((e,t)=>{let{className:a,...n}=e;return(0,l.jsx)(w.wn,{ref:t,className:(0,u.cn)("flex cursor-default items-center justify-center py-1",a),...n,children:(0,l.jsx)(b.A,{className:"h-4 w-4"})})});S.displayName=w.wn.displayName;let A=n.forwardRef((e,t)=>{let{className:a,children:n,position:s="popper",...r}=e;return(0,l.jsx)(w.ZL,{children:(0,l.jsxs)(w.UC,{ref:t,className:(0,u.cn)("relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2","popper"===s&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",a),position:s,...r,children:[(0,l.jsx)(I,{}),(0,l.jsx)(w.LM,{className:(0,u.cn)("p-1","popper"===s&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:n}),(0,l.jsx)(S,{})]})})});A.displayName=w.UC.displayName,n.forwardRef((e,t)=>{let{className:a,...n}=e;return(0,l.jsx)(w.JU,{ref:t,className:(0,u.cn)("py-1.5 pl-8 pr-2 text-sm font-semibold",a),...n})}).displayName=w.JU.displayName;let E=n.forwardRef((e,t)=>{let{className:a,children:n,...s}=e;return(0,l.jsxs)(w.q7,{ref:t,className:(0,u.cn)("relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",a),...s,children:[(0,l.jsx)("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:(0,l.jsx)(w.VF,{children:(0,l.jsx)(N.A,{className:"h-4 w-4"})})}),(0,l.jsx)(w.p4,{children:n})]})});function R(){return(0,l.jsx)("div",{className:"absolute inset-0 pointer-events-none z-20 overflow-hidden rounded-lg",children:(0,l.jsx)("div",{className:"absolute -top-1/2 w-1/12 h-[200%] bg-white/30 animate-sheen"})})}function z(){return(0,l.jsx)("div",{className:"absolute inset-0 pointer-events-none z-20 overflow-hidden",children:Array.from({length:10}).map((e,t)=>(0,l.jsx)(r.A,{className:"absolute animate-sparkle",style:{top:"".concat(100*Math.random(),"%"),left:"".concat(100*Math.random(),"%"),animationDelay:"".concat(1.5*Math.random(),"s"),color:"hsl(".concat(360*Math.random(),", 100%, 70%)"),width:"".concat(5+5*Math.random(),"px"),height:"".concat(5+5*Math.random(),"px")}},t))})}function P(){return(0,l.jsx)("div",{className:"absolute inset-0 pointer-events-none z-20 overflow-hidden",children:Array.from({length:7}).map((e,t)=>(0,l.jsx)(r.A,{className:"absolute text-red-500 animate-sparkle",style:{top:"".concat(100*Math.random(),"%"),left:"".concat(100*Math.random(),"%"),animationDelay:"".concat(1.5*Math.random(),"s"),width:"".concat(8+8*Math.random(),"px"),height:"".concat(8+8*Math.random(),"px")}},t))})}function D(){return(0,l.jsx)("div",{className:"absolute inset-0 pointer-events-none z-20 overflow-hidden",children:Array.from({length:7}).map((e,t)=>(0,l.jsx)(r.A,{className:"absolute text-yellow-300 animate-sparkle",style:{top:"".concat(100*Math.random(),"%"),left:"".concat(100*Math.random(),"%"),animationDelay:"".concat(1.5*Math.random(),"s"),width:"".concat(5+5*Math.random(),"px"),height:"".concat(5+5*Math.random(),"px")}},t))})}function U(e){let{plant:t,image:a}=e;return(0,l.jsx)("div",{className:(0,u.cn)("flex items-center justify-center p-1 rounded-lg pointer-events-none w-full h-full"),children:(0,l.jsxs)("div",{className:"relative h-32 w-32 sm:h-36 sm:w-36 flex items-center justify-center",children:[a&&"placeholder"!==a?(0,l.jsx)(c.default,{src:a,alt:t.name,fill:!0,sizes:"144px",className:"object-contain","data-ai-hint":t.hint}):(0,l.jsx)("div",{className:"w-full h-full flex items-center justify-center rounded-lg",children:(0,l.jsx)(i.A,{className:"w-12 h-12 text-transparent"})}),t.hasGlitter&&(0,l.jsx)(D,{}),t.hasRedGlitter&&(0,l.jsx)(P,{}),t.hasSheen&&(0,l.jsx)(R,{}),t.hasRainbowGlitter&&(0,l.jsx)(z,{})]})})}function F(e){let{plant:t,onClick:a}=e,{attributes:n,listeners:r,setNodeRef:o,isDragging:d}=(0,p.PM)({id:"collection:".concat(t.id),data:{plant:t,source:"collection"}});return(0,l.jsx)(s.Zp,{ref:o,style:{opacity:d?.4:1},className:"touch-none cursor-grab active:cursor-grabbing",...n,...r,onClick:()=>a(t),children:(0,l.jsx)("div",{className:"group overflow-hidden shadow-md w-full relative pointer-events-none",children:(0,l.jsxs)(s.Wu,{className:"p-0",children:[(0,l.jsxs)("div",{className:"aspect-square relative flex items-center justify-center bg-muted/30",children:["placeholder"!==t.image?(0,l.jsx)(c.default,{src:t.image,alt:t.name,fill:!0,sizes:"100px",className:"object-cover","data-ai-hint":t.hint}):(0,l.jsx)(i.A,{className:"w-1/2 h-1/2 text-muted-foreground/40"}),t.hasGlitter&&(0,l.jsx)(D,{}),t.hasRedGlitter&&(0,l.jsx)(P,{}),t.hasSheen&&(0,l.jsx)(R,{}),t.hasRainbowGlitter&&(0,l.jsx)(z,{})]}),(0,l.jsx)("div",{className:"p-2 text-center bg-white/50 space-y-1",children:(0,l.jsx)("p",{className:"text-sm font-semibold text-primary truncate",children:t.name})})]})})})}function G(e){let{plant:t,...a}=e,{attributes:n,listeners:s,setNodeRef:r,isDragging:i}=(0,p.PM)({id:"desk:".concat(t.id),data:{plant:t,source:"desk"}});return(0,l.jsx)("div",{ref:r,style:{opacity:i?.4:1},...s,...n,...a,className:(0,u.cn)(a.className,"cursor-grab active:cursor-grabbing touch-none w-full h-full z-10"),children:(0,l.jsx)(U,{plant:t,image:t.image})})}function O(e){let{plant:t,index:a,onClickPlant:n,processedImage:s}=e,{setNodeRef:r,isOver:i}=(0,p.zM)({id:"pot:".concat(a)});return t?(0,l.jsxs)("div",{className:"relative w-full h-full flex items-center justify-center",children:[(0,l.jsx)(G,{plant:{...t,image:s||t.image},onClick:()=>n(t)}),(0,l.jsx)("div",{ref:r,className:(0,u.cn)("absolute inset-0 z-0",i&&"bg-black/20 rounded-lg")})]}):(0,l.jsx)(()=>(0,l.jsx)("div",{ref:r,className:(0,u.cn)("relative w-full h-full flex items-center justify-center rounded-lg transition-colors",i?"bg-black/20":"bg-black/10")}),{})}function L(e){let{children:t}=e,{isOver:a,setNodeRef:n}=(0,p.zM)({id:"collection:area"});return(0,l.jsx)("div",{ref:n,className:(0,u.cn)("rounded-lg border bg-muted/10 p-2 min-h-24",a&&"bg-primary/10 border-2 border-dashed border-primary/50"),children:t})}function _(){let{user:e,gameData:t}=(0,h.A)(),{toast:a}=(0,m.dj)(),[i,c]=(0,n.useState)([]),[u,j]=(0,n.useState)(null),[w,b]=(0,n.useState)("level"),[y,N]=(0,n.useState)({}),[I,S]=(0,n.useState)(null),[R,z]=(0,n.useState)(null),[P,D]=(0,n.useState)(null),[G,_]=(0,n.useState)(!1),[Z,W]=(0,n.useState)(null),q=(0,p.FR)((0,p.MS)(p.AN,{activationConstraint:{distance:8}}),(0,p.MS)(p.IG,{activationConstraint:{delay:150,tolerance:5}}));(0,n.useEffect)(()=>{t&&c(t.deskPlantIds||[,,,].fill(null))},[t]);let J=(0,n.useMemo)(()=>(null==t?void 0:t.plants)||{},[t]),B=(0,n.useMemo)(()=>{let e={Base:0,Evolved:1,Final:2};return Object.values(J).filter(e=>!i.includes(e.id)).sort((t,a)=>"level"===w?a.level-t.level:e[a.form]-e[t.form])},[J,i,w]),H=(0,n.useMemo)(()=>i.map(e=>e?J[e]:null),[i,J]);(0,n.useEffect)(()=>{(async()=>{let e={};for(let t of H)if(t&&t.image)if(t.image.startsWith("/"))e[t.id]=t.image;else try{let a=await (0,f.x)(t.image);e[t.id]=a}catch(a){console.error("Failed to process image for plant:",t.id,a),e[t.id]=t.image}N(e)})()},[H]);let K=async a=>{var l;if(j(null),!e||!t)return;let{active:n,over:s}=a;if(!s||!(null==(l=n.data.current)?void 0:l.plant))return;let r=n.data.current.plant,[o]=n.id.split(":"),[d,c]=s.id.split(":"),m=[...i],u=B.map(e=>e.id);if("pot"===d){let t=parseInt(c,10),a=m[t];m[t]=r.id;let l=[...u];if("desk"===o){let e=i.findIndex(e=>e===r.id);-1!==e&&e!==t&&(m[e]=a)}else l=u.filter(e=>e!==r.id);a&&!l.includes(a)&&l.push(a),await (0,x.hj)(e.uid,l,m)}else if("collection"===d&&"desk"===o){let t=i.findIndex(e=>e===r.id);-1!==t&&(m[t]=null);let a=[...u];a.includes(r.id)||a.push(r.id),await (0,x.hj)(e.uid,a,m)}},V=async()=>{if(R&&e){_(!0);try{let{newImageDataUri:e,personality:t}=await v({name:R.name,baseImageDataUri:R.uncompressedImage,form:R.form}),a="Base"===R.form?"Evolved":"Final",l=await (0,f.w)(e);W({plantId:R.id,plantName:R.name,newForm:a,newImageUri:l,uncompressedNewImageUri:e,personality:t}),z(null)}catch(e){console.error("Evolution failed",e),a({variant:"destructive",title:"Evolution Failed",description:"Could not evolve your plant. Please try again."}),_(!1),z(null)}}},Y=async()=>{if(e&&Z&&t){_(!0);try{let{plantId:t,newImageUri:l,uncompressedNewImageUri:n,newForm:s,personality:r}=Z,i=J[t],o={image:l,uncompressedImage:n,form:s,personality:r||""};"Evolved"===s&&i&&!i.baseImage&&(o.baseImage=i.image),await (0,x.Z8)(e.uid,t,o),a({title:"Evolution Complete!",description:"".concat(Z.plantName," has evolved!")})}catch(e){console.error("Failed to save evolution",e),a({variant:"destructive",title:"Save Failed",description:"Could not save your evolved plant."})}finally{_(!1),W(null)}}},T=e=>{S(J[e.id])};return e&&t?(0,l.jsx)(p.Mp,{sensors:q,onDragStart:e=>{var t;j(null==(t=e.active.data.current)?void 0:t.plant)},onDragEnd:K,onDragCancel:()=>j(null),children:(0,l.jsxs)("div",{className:"space-y-4 bg-white min-h-screen",children:[(0,l.jsxs)("header",{className:"flex flex-col items-center gap-2 p-4 text-center",children:[(0,l.jsx)("h1",{className:"text-3xl text-primary text-center",children:"My Room"}),(0,l.jsx)("p",{className:"text-muted-foreground text-sm",children:"Drag plants to your desk, then click them to view details or apply cosmetics."})]}),(0,l.jsx)("section",{className:"px-4",children:(0,l.jsxs)("div",{className:"flex justify-center gap-4 text-sm text-muted-foreground mb-4 flex-wrap",children:[(0,l.jsxs)("div",{className:"flex items-center gap-1.5 p-2 rounded-lg bg-yellow-100/80 border border-yellow-300/80",children:[(0,l.jsx)(r.A,{className:"w-5 h-5 text-yellow-500"}),(0,l.jsx)("span",{children:t.glitterCount})]}),(0,l.jsxs)("div",{className:"flex items-center gap-1.5 p-2 rounded-lg bg-blue-100/80 border border-blue-300/80",children:[(0,l.jsx)(d.A,{className:"w-5 h-5 text-blue-500"}),(0,l.jsx)("span",{children:t.sheenCount})]}),(0,l.jsxs)("div",{className:"flex items-center gap-1.5 p-2 rounded-lg bg-pink-100/80 border border-pink-300/80",children:[(0,l.jsx)(r.A,{className:"w-5 h-5 text-pink-500"}),(0,l.jsx)("span",{children:t.rainbowGlitterCount})]}),(0,l.jsxs)("div",{className:"flex items-center gap-1.5 p-2 rounded-lg bg-red-100/80 border border-red-300/80",children:[(0,l.jsx)(r.A,{className:"w-5 h-5 text-red-500"}),(0,l.jsx)("span",{children:t.redGlitterCount})]})]})}),(0,l.jsx)("section",{className:"relative h-48 max-w-lg mx-auto rounded-lg bg-cover bg-center",style:{backgroundImage:"url('/desk.jpg')"},children:(0,l.jsx)("div",{className:"absolute inset-x-0 top-0 h-40 p-4 sm:p-6 md:p-8 grid grid-cols-3 grid-rows-1 gap-2",children:H.slice(0,3).map((e,t)=>(0,l.jsx)(O,{plant:e,index:t,onClickPlant:T,processedImage:e?y[e.id]:null},(null==e?void 0:e.id)||"pot-".concat(t)))})}),(0,l.jsx)("section",{className:"px-4 pb-24",children:(0,l.jsxs)(s.Zp,{className:"p-4",children:[(0,l.jsx)("div",{className:"flex flex-col items-center gap-4",children:(0,l.jsxs)("div",{className:"w-full flex justify-between items-center mb-2",children:[(0,l.jsx)("h2",{className:"text-xl text-primary",children:"My Collection"}),(0,l.jsxs)(C,{value:w,onValueChange:e=>b(e),children:[(0,l.jsx)(k,{className:"w-[150px] h-9",children:(0,l.jsx)(M,{placeholder:"Sort by..."})}),(0,l.jsxs)(A,{children:[(0,l.jsx)(E,{value:"level",children:"Sort by Level"}),(0,l.jsx)(E,{value:"stage",children:"Sort by Stage"})]})]})]})}),(0,l.jsx)(L,{children:(0,l.jsx)("div",{className:"grid grid-cols-3 gap-4 sm:grid-cols-4 md:grid-cols-5",children:B.length>0?B.map(e=>(0,l.jsx)(F,{plant:e,onClick:T},e.id)):(0,l.jsx)("div",{className:"col-span-3 text-center text-muted-foreground py-8",children:"Your collection is empty. Go to the Home screen to draw a new plant!"})})})]})}),(0,l.jsx)(g.bc,{plant:I,open:!!I,onOpenChange:e=>!e&&S(null),onStartEvolution:e=>{S(null),z(e)},onOpenChat:e=>D(e),userId:e.uid}),(0,l.jsx)(g.SS,{plant:P,open:!!P,onOpenChange:e=>!e&&D(null),userId:e.uid}),(0,l.jsx)(g.dy,{plant:R,open:!!R&&!G,onConfirm:V,onCancel:()=>z(null),isEvolving:G}),(0,l.jsx)(g.KK,{plantName:(null==Z?void 0:Z.plantName)||"",newForm:(null==Z?void 0:Z.newForm)||"",newImageUri:(null==Z?void 0:Z.newImageUri)||"",open:!!Z,onConfirm:Y}),(0,l.jsx)(p.Hd,{children:u?(0,l.jsx)(s.Zp,{children:(0,l.jsx)(s.Wu,{className:"p-0",children:(0,l.jsx)("div",{className:"w-28 h-28",children:(0,l.jsx)(U,{plant:u,image:u.image})})})}):null})]})}):(0,l.jsx)("div",{className:"flex h-screen w-full items-center justify-center bg-white",children:(0,l.jsx)(o.A,{className:"h-8 w-8 animate-spin text-primary"})})}E.displayName=w.q7.displayName,n.forwardRef((e,t)=>{let{className:a,...n}=e;return(0,l.jsx)(w.wv,{ref:t,className:(0,u.cn)("-mx-1 my-1 h-px bg-muted",a),...n})}).displayName=w.wv.displayName},8138:(e,t,a)=>{"use strict";async function l(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1024;return new Promise((a,l)=>{let n=new window.Image;n.crossOrigin="anonymous",n.onload=()=>{let e=document.createElement("canvas"),{width:s,height:r}=n;s>r?s>t&&(r=Math.round(r*t/s),s=t):r>t&&(s=Math.round(s*t/r),r=t),e.width=s,e.height=r;let i=e.getContext("2d");if(!i)return l(Error("Could not get canvas context"));i.drawImage(n,0,0,s,r),a(e.toDataURL("image/jpeg",.8))},n.onerror=l,n.src=e})}async function n(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:240;return new Promise((a,l)=>{let n=new window.Image;n.crossOrigin="anonymous",n.onload=()=>{let e=document.createElement("canvas"),{width:s,height:r}=n;e.width=s,e.height=r;let i=e.getContext("2d");if(!i)return l(Error("Could not get canvas context"));i.drawImage(n,0,0);let o=i.getImageData(0,0,s,r),d=o.data;for(let e=0;e<d.length;e+=4){let a=d[e],l=d[e+1],n=d[e+2];a>t&&l>t&&n>t&&(d[e+3]=0)}i.putImageData(o,0,0),a(e.toDataURL("image/png"))},n.onerror=t=>{console.warn("CORS or other error making background transparent, returning original image",t),a(e)},n.src=e})}a.d(t,{w:()=>l,x:()=>n})}},e=>{e.O(0,[992,416,909,382,39,476,667,806,196,560,35,233,441,255,358],()=>e(e.s=506)),_N_E=e.O()}]);