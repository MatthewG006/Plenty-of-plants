(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[976],{96:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>Z});var a=s(5155),n=s(2115),r=s(3998),l=s(6948),i=s(5740),o=s(8854),c=s(9347),d=s(5299),u=s(7801),m=s(5626),x=s(9559),h=s(1169),f=s(5921),p=s(6613),v=s(5239),j=s(5894),b=s(4269),N=s(9689),g=s(4901),w=s(926);let y=(0,w.createServerReference)("605f9838793076e9870ca01e21d9376b0715394958",w.callServer,void 0,w.findSourceMapURL,"sendHeartbeat"),S=(0,w.createServerReference)("404727f97cf64239d80ee3a9f54c6de6322c7f33a7",w.callServer,void 0,w.findSourceMapURL,"processContestState"),C=(0,w.createServerReference)("78a218c5b1d991013d1ca19cbaebb93a4dd91cfdb4",w.callServer,void 0,w.findSourceMapURL,"joinContest"),A=(0,w.createServerReference)("60b12aab991d43180e8e67b5b5f93f1346e524b4d6",w.callServer,void 0,w.findSourceMapURL,"startContestManually"),R=(0,w.createServerReference)("709328934fb34b0e3b0b8e87707fbfa741f4638731",w.callServer,void 0,w.findSourceMapURL,"voteForContestant");var E=s(2619),I=s.n(E),M=s(9708),D=s(4585),T=s(1708),W=s(233),k=s(63);let O=[{top:"20%",left:"15%"},{top:"20%",left:"65%"},{top:"55%",left:"15%"},{top:"55%",left:"65%"}];function V(){return(0,a.jsx)("div",{className:"absolute inset-0 pointer-events-none z-20 overflow-hidden",children:Array.from({length:7}).map((e,t)=>(0,a.jsx)(i.A,{className:"absolute text-yellow-300 animate-sparkle",style:{top:"".concat(100*Math.random(),"%"),left:"".concat(100*Math.random(),"%"),animationDelay:"".concat(1.5*Math.random(),"s"),width:"".concat(5+5*Math.random(),"px"),height:"".concat(5+5*Math.random(),"px")}},t))})}function F(e){let{contestant:t,onVote:s,hasVoted:n,isWinner:i}=e;return(0,a.jsxs)(l.Zp,{className:(0,b.cn)("text-center transition-all relative overflow-hidden",i&&"border-yellow-400 border-2 shadow-yellow-300/50 shadow-lg"),children:[i&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"absolute top-2 right-2 text-yellow-400 z-10",children:(0,a.jsx)(o.A,{className:"w-8 h-8",fill:"currentColor"})}),(0,a.jsx)(V,{})]}),(0,a.jsxs)(l.Wu,{className:"p-2",children:[(0,a.jsx)("div",{className:"aspect-square rounded-md bg-muted/50 mb-2 relative",children:(0,a.jsx)(v.default,{src:t.image,alt:t.name,fill:!0,sizes:"150px",className:"object-cover"})}),(0,a.jsx)("h3",{className:"font-bold text-primary truncate",children:t.name}),(0,a.jsxs)("p",{className:"text-xs text-muted-foreground truncate",children:["by ",t.ownerName]}),(0,a.jsxs)("div",{className:"flex items-center justify-center gap-1.5 mt-1 text-muted-foreground",children:[(0,a.jsx)(c.A,{className:(0,b.cn)("w-4 h-4",t.votes>0&&"text-yellow-500 fill-current")}),(0,a.jsx)("span",{className:"text-sm font-medium",children:t.votes})]}),(0,a.jsx)(r.$,{onClick:()=>s(t.id),size:"sm",className:"w-full mt-2",disabled:n,children:n?"Voted":"Vote"})]})]})}function Z(){let{user:e,gameData:t}=(0,g.A)(),{toast:s}=(0,j.dj)(),{playSfx:i}=(0,N.n)(),o=(0,k.useRouter)(),c=(0,k.useParams)().sessionId,[b,w]=(0,n.useState)(!0),[E,V]=(0,n.useState)(!1),[Z,z]=(0,n.useState)(null),[L,P]=(0,n.useState)(null),[Y,$]=(0,n.useState)([]),[_,B]=(0,n.useState)(!1),[U,q]=(0,n.useState)(!1),[H,J]=(0,n.useState)(0),Q=e&&Y.some(t=>t.ownerId===e.uid),G=e&&Y.some(t=>{var s;return null==(s=t.voterIds)?void 0:s.includes(e.uid)}),K=e&&(null==L?void 0:L.hostId)===e.uid;(0,n.useEffect)(()=>{if(e&&Q&&(null==L?void 0:L.status)==="waiting"&&c){let t=setInterval(()=>{y(c,e.uid)},1e4);return y(c,e.uid),()=>clearInterval(t)}},[e,Q,null==L?void 0:L.status,c]),(0,n.useEffect)(()=>{let e;if(!L||"finished"===L.status)return;let t=()=>{if(L.expiresAt){var e;let t=Math.max(0,Math.floor((((null==(e=L.expiresAt)?void 0:e.seconds)?new M.Dc(L.expiresAt.seconds,L.expiresAt.nanoseconds).toDate().getTime():new Date(L.expiresAt).getTime())-Date.now())/1e3));J(t),t<=0&&S(c)}};return t(),e=setInterval(t,1e3),()=>clearInterval(e)},[L,c]),(0,n.useEffect)(()=>{(null==L?void 0:L.status)==="finished"&&L.winner&&(0,T.A)({particleCount:150,spread:180,origin:{y:.6}})},[null==L?void 0:L.status,null==L?void 0:L.winner]),(0,n.useEffect)(()=>{if(!e||!c)return void w(!1);w(!0);let t=(0,M.aQ)((0,M.H9)(D.db,"contestSessions",c),e=>{if(e.exists()){var t,s;let a=e.data();P({id:e.id,...a,createdAt:(null==(t=a.createdAt)?void 0:t.toDate)?a.createdAt.toDate().toISOString():new Date().toISOString(),expiresAt:(null==(s=a.expiresAt)?void 0:s.toDate)?a.expiresAt.toDate().toISOString():new Date().toISOString()})}else P(null),z("This contest lobby no longer exists.");w(!1)},e=>{console.error("Snapshot error:",e),z("Could not connect to the contest service."),w(!1)}),s=(0,M.aQ)((0,M.rJ)(D.db,"contestSessions",c,"contestants"),e=>{$(e.docs.map(e=>({id:e.id,...e.data()})))});return()=>{t(),s()}},[e,c]),(0,n.useEffect)(()=>{if(Z){let e=setTimeout(()=>{o.push("/community/contest")},3e3);return()=>clearTimeout(e)}},[Z,o]);let X=async t=>{if(e&&e.displayName){B(!1),q(!0),z(null);try{let{success:a,error:n}=await C(c,e.uid,e.displayName,t);if(n)throw Error(n);a&&s({title:"You have entered the contest!"})}catch(e){console.error("Failed to join contest:",e),z(e.message||"Failed to join the contest."),s({variant:"destructive",title:"Contest Error",description:e.message})}finally{q(!1)}}},ee=async()=>{if(e&&K){V(!0);try{let{success:t,error:a}=await A(c,e.uid);if(!t)throw Error(a||"Failed to start contest.");i("success"),s({title:"Contest Started!",description:"The first voting round has begun."})}catch(e){console.error("Failed to start contest:",e),s({variant:"destructive",title:"Start Error",description:e.message})}finally{V(!1)}}},et=async t=>{if(e&&L&&c)try{i("tap"),await R(c,e.uid,t),s({title:"Vote Cast!",description:"Your vote has been counted."})}catch(e){console.error(e),s({variant:"destructive",title:"Voting Error",description:e.message})}};return b||U||E?(0,a.jsxs)("div",{className:"flex h-screen w-full items-center justify-center",children:[(0,a.jsx)(d.A,{className:"h-8 w-8 animate-spin text-primary"}),(0,a.jsx)("p",{className:"ml-2",children:U?"Joining contest...":E?"Starting contest...":"Finding contest..."})]}):Z||!L?(0,a.jsxs)(l.Zp,{className:"m-4 text-center py-10 border-destructive",children:[(0,a.jsxs)(l.aR,{children:[(0,a.jsx)("div",{className:"mx-auto bg-destructive/10 rounded-full w-fit p-3 mb-2",children:(0,a.jsx)(u.A,{className:"h-10 w-10 text-destructive"})}),(0,a.jsx)(l.ZB,{className:"text-destructive",children:"Contest Error"}),(0,a.jsxs)(l.BT,{children:[Z||"The contest session could not be found.",(0,a.jsx)("br",{}),"You will be returned to the lobby list shortly."]})]}),(0,a.jsx)(l.Wu,{children:(0,a.jsx)(d.A,{className:"h-6 w-6 animate-spin text-destructive mx-auto"})})]}):(0,a.jsxs)("div",{className:"p-4 space-y-4 pb-20",children:[(0,a.jsxs)("header",{className:"flex items-center justify-between pb-2",children:[(0,a.jsx)(r.$,{asChild:!0,variant:"ghost",size:"icon",children:(0,a.jsx)(I(),{href:"/community/contest",children:(0,a.jsx)(m.A,{})})}),(0,a.jsx)("h1",{className:"text-2xl text-primary font-bold text-center",children:"Plant Beauty Contest"}),(0,a.jsx)("div",{className:"w-10"})]}),(0,a.jsxs)(l.Zp,{className:"text-center p-4 bg-muted/50",children:[(0,a.jsxs)("h2",{className:"text-lg font-semibold text-primary",children:["Round ",L.round]}),(0,a.jsxs)("p",{className:"text-sm text-muted-foreground",children:["waiting"===L.status&&"Waiting for players... (".concat(L.contestantCount,"/").concat(O.length,")"),"voting"===L.status&&"Vote for your favorite!","finished"===L.status&&"Contest Over!"]}),(0,a.jsx)("div",{className:"text-3xl font-bold text-primary mt-1",children:H>0?"".concat(H,"s"):"0s"})]}),"waiting"===L.status&&H<=0&&L.contestantCount<2&&(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("p",{className:"text-sm text-muted-foreground mb-2",children:"The lobby timer has expired."}),(0,a.jsxs)(r.$,{onClick:()=>window.location.reload(),children:[(0,a.jsx)(x.A,{className:"mr-2 h-4 w-4"}),"Refresh Status"]})]}),"waiting"===L.status&&(0,a.jsxs)(l.Zp,{className:"relative min-h-[400px]",children:[(0,a.jsx)(l.aR,{children:(0,a.jsxs)(l.ZB,{className:"flex items-center gap-2",children:[(0,a.jsx)(h.A,{})," Contest Lobby"]})}),(0,a.jsxs)(l.Wu,{children:[(0,a.jsx)("div",{className:"absolute inset-0",children:Y.map((t,s)=>{let n=O[s%O.length];return(0,a.jsxs)("div",{className:"absolute w-1/4",style:{top:n.top,left:n.left},children:[(0,a.jsx)("div",{className:"relative aspect-square",children:(0,a.jsx)(v.default,{src:t.image,alt:t.name,fill:!0,sizes:"100px",className:"object-contain"})}),(0,a.jsxs)("p",{className:"text-center text-xs font-bold text-primary truncate",children:[t.ownerName,t.ownerId===(null==e?void 0:e.uid)&&(0,a.jsx)("span",{className:"text-muted-foreground",children:" (You)"})]})]},t.id)})}),(0,a.jsxs)("div",{className:"absolute bottom-4 left-4 right-4 flex flex-col gap-2",children:[K&&(0,a.jsxs)(r.$,{className:"w-full",onClick:ee,disabled:Y.length<2||H<=0,children:[(0,a.jsx)(f.A,{className:"mr-2"}),"Start Contest"]}),!Q&&H>0&&L.contestantCount<O.length?(0,a.jsxs)(r.$,{className:"w-full",onClick:()=>B(!0),variant:K?"secondary":"default",children:[(0,a.jsx)(p.A,{className:"mr-2"}),"Enter Your Plant!"]}):null,(0,a.jsx)("p",{className:"text-xs text-muted-foreground text-center",children:K?Y.length<2?"Waiting for more players...":"You can start the contest now.":"Waiting for the host to start the contest..."})]})]})]}),"voting"===L.status&&(0,a.jsx)("div",{className:"grid grid-cols-2 gap-4",children:Y.map(e=>(0,a.jsx)(F,{contestant:e,onVote:et,hasVoted:!!G,isWinner:!1},e.id))}),"finished"===L.status&&L.winner&&(0,a.jsxs)(l.Zp,{children:[(0,a.jsx)(l.aR,{className:"items-center",children:(0,a.jsx)(l.ZB,{className:"text-2xl text-yellow-500",children:"We have a winner!"})}),(0,a.jsxs)(l.Wu,{children:[(0,a.jsx)(F,{contestant:L.winner,onVote:()=>{},hasVoted:!0,isWinner:!0}),(0,a.jsxs)("div",{className:"text-center mt-4 space-y-2",children:[(0,a.jsxs)("p",{children:["Congratulations to ",(0,a.jsx)("span",{className:"font-bold text-primary",children:L.winner.ownerName}),"!"]}),(0,a.jsx)("p",{className:"text-muted-foreground text-sm",children:"They have been awarded 50 gold and a special Red Glitter cosmetic!"}),(0,a.jsx)(r.$,{asChild:!0,className:"mt-4",children:(0,a.jsx)(I(),{href:"/community/contest",children:"Find a New Contest"})})]})]})]}),(0,a.jsx)(W.ir,{open:_,onOpenChange:B,allPlants:Object.values((null==t?void 0:t.plants)||{}),onSelectPlant:X})]})}},9441:(e,t,s)=>{Promise.resolve().then(s.bind(s,96))}},e=>{e.O(0,[992,416,909,382,619,39,476,667,806,535,560,35,233,441,255,358],()=>e(e.s=9441)),_N_E=e.O()}]);