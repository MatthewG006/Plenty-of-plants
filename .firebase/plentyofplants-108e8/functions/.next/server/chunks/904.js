"use strict";exports.id=904,exports.ids=[904],exports.modules={25904:(a,b,c)=>{c.r(b),c.d(b,{"006f03c26a91e8230ee43c7858e57087338a37e4ac":()=>n,"00b166d64f15316511da8f7dd4422c78f9eeecd41b":()=>m,"404727f97cf64239d80ee3a9f54c6de6322c7f33a7":()=>s,"40ff5d7db5ce3e834a114b4fed95a7f4937090b6fd":()=>t.o,"605f9838793076e9870ca01e21d9376b0715394958":()=>r,"60b12aab991d43180e8e67b5b5f93f1346e524b4d6":()=>l,"706f3b3e02c029cb03e5a6dcee30486c0b2e9a1e5b":()=>o,"709328934fb34b0e3b0b8e87707fbfa741f4638731":()=>q,"78a218c5b1d991013d1ca19cbaebb93a4dd91cfdb4":()=>p});var d=c(91488);c(27806);var e=c(53849),f=c(54409),g=c(96616);let h=(0,e.Dk)().length?(0,e.Sx)():(0,e.Wp)({apiKey:"AIzaSyBxgn4A1fMUdIwUKdDh4KWyjJTSle2dXQE",authDomain:"plentyofplants-108e8.firebaseapp.com",projectId:"plentyofplants-108e8",storageBucket:"plentyofplants-108e8.appspot.com",messagingSenderId:"317861154450",appId:"1:317861154450:web:3a586f3cc5b1c42e64e04b"});(0,f.xI)(h);let i=(0,g.aU)(h);var j=c(83183);async function k(a){let b=(0,g.H9)(i,"users",a);await (0,g.mZ)(b,{redGlitterCount:(0,g.GV)(1),gold:(0,g.GV)(50)})}async function l(a,b){let c=(0,g.H9)(i,"contestSessions",a);try{return await (0,g.c4)(i,async a=>{let d=await a.get(c);if(!d.exists())throw Error("Session not found.");let e=d.data();if("waiting"!==e.status)throw Error("The contest has already started.");if(e.hostId!==b)throw Error("Only the host can start the contest.");let f=(0,g.rJ)(c,"contestants");if((await (0,g.GG)((0,g.P)(f))).docs.map(a=>({...a.data(),id:a.id})).length<2)throw Error("You need at least 2 players to start the contest.");a.update(c,{status:"voting",expiresAt:g.Dc.fromMillis(Date.now()+3e4)})}),{success:!0}}catch(a){return console.error("Error starting contest manually:",a),{success:!1,error:a.message||"Could not start the contest."}}}async function m(){let a=g.Dc.now(),b=(0,g.rJ)(i,"contestSessions"),c=(0,g.P)(b,(0,g._M)("status","==","waiting"),(0,g._M)("expiresAt","<=",a)),d=(0,g.P)(b,(0,g._M)("status","==","voting"),(0,g._M)("expiresAt","<=",a));try{let[a,b]=await Promise.all([(0,g.GG)(c),(0,g.GG)(d)]);for(let c of[...a.docs,...b.docs])await s(c.id)}catch(a){console.error("Error during contest cleanup:",a)}}async function n(){let a=(0,g.rJ)(i,"contestSessions"),b=(0,g.P)(a,(0,g._M)("status","==","waiting"));return(await (0,g.GG)(b)).docs.map(a=>{let b=a.data(),c=b.createdAt,d=b.expiresAt;return{id:a.id,...b,createdAt:c?.toDate?c.toDate().toISOString():new Date().toISOString(),expiresAt:d?.toDate?d.toDate().toISOString():new Date().toISOString()}})}async function o(a,b,c){try{if(!c)throw Error("A valid plant must be provided to create a contest.");return{sessionId:await (0,g.c4)(i,async d=>{let e=(0,g.H9)((0,g.rJ)(i,"contestSessions")),f={status:"waiting",createdAt:(0,g.O5)(),expiresAt:g.Dc.fromMillis(Date.now()+18e4),round:1,contestantCount:1,hostId:a,hostName:b};d.set(e,f);let h=(0,g.H9)((0,g.rJ)(e,"contestants")),{id:j,...k}=c,l={...k,id:h.id,ownerId:a,ownerName:b,votes:0,voterIds:[],lastSeen:g.Dc.now()};return d.set(h,l),e.id})}}catch(a){return console.error("Error creating new contest:",a),{error:a.message||"An unknown error occurred while creating the contest."}}}async function p(a,b,c,d){try{return await (0,g.c4)(i,async e=>{let f=(0,g.H9)(i,"contestSessions",a),h=await e.get(f);if(!h.exists()||"waiting"!==h.data().status)throw Error("This contest is no longer accepting new players.");if(h.data().contestantCount>=4)throw Error("This contest lobby is full.");let j=(0,g.rJ)(f,"contestants"),k=(0,g.P)(j,(0,g._M)("ownerId","==",b)),l=await (0,g.GG)(k);if(!l.empty&&!l.docs.some(b=>b.ref.parent.parent?.id!==a))throw Error("You have already entered this contest.");let m=(0,g.H9)(j),{id:n,...o}=d,p={...o,id:m.id,ownerId:b,ownerName:c,votes:0,voterIds:[],lastSeen:g.Dc.now()};e.set(m,p),e.update(f,{contestantCount:(0,g.GV)(1)})}),{success:!0}}catch(a){return console.error("Error joining contest:",a),{success:!1,error:a.message||"Failed to join contest."}}}async function q(a,b,c){try{return await (0,g.c4)(i,async d=>{let e=(0,g.H9)(i,"contestSessions",a),f=(0,g.H9)(e,"contestants",c),h=await d.get(e);if(!h.exists()||"voting"!==h.data().status)throw Error("Voting for this contest has ended.");let j=(0,g.rJ)(e,"contestants");if((await (0,g.GG)((0,g.P)(j))).docs.map(a=>a.data()).some(a=>a.voterIds?.includes(b)))throw Error("You have already voted in this round.");let k=await d.get(f);if(!k.exists())throw Error("This contestant is no longer in the running.");if(k.data().ownerId===b)throw Error("You cannot vote for your own plant.");d.update(f,{votes:(0,g.GV)(1),voterIds:(0,g.hq)(b)})}),{success:!0}}catch(a){return console.error("Error casting vote:",a),{success:!1,error:a.message||"Failed to cast vote."}}}async function r(a,b){let c=(0,g.rJ)(i,"contestSessions",a,"contestants"),d=(0,g.P)(c,(0,g._M)("ownerId","==",b));try{let a=await (0,g.GG)(d);if(!a.empty){let b=a.docs[0];await (0,g.mZ)(b.ref,{lastSeen:g.Dc.now()})}}catch(a){console.error("Error sending heartbeat:",a)}}async function s(a){let b=(0,g.H9)(i,"contestSessions",a);try{await (0,g.c4)(i,async a=>{let c=await a.get(b);if(!c.exists())throw Error("Session not found.");let d=c.data();if("finished"===d.status)return;let e=(0,g.rJ)(b,"contestants"),f=(await (0,g.GG)((0,g.P)(e))).docs.map(a=>({...a.data(),id:a.id}));if("waiting"===d.status){let c=g.Dc.now().seconds,d=f.filter(a=>c-(a.lastSeen?.seconds||0)<30);if(d.length<f.length){for(let b of f.filter(a=>!d.find(b=>b.id===a.id)))a.delete((0,g.H9)(e,b.id));a.update(b,{contestantCount:d.length})}d.length<2&&a.update(b,{status:"finished",winner:null});return}if("voting"===d.status){if(0===f.length)return void a.update(b,{status:"finished",winner:null});let c=Math.max(...f.map(a=>a.votes||0),0),d=f.filter(a=>(a.votes||0)===c);if(1===d.length&&f.length>1){let c=d[0];a.update(b,{status:"finished",winner:c})}else{if(d.length<=1){let c=d[0]||f[0];a.update(b,{status:"finished",winner:c});return}for(let b of f.filter(a=>(a.votes||0)<c))a.delete((0,g.H9)(e,b.id));for(let b of d)a.update((0,g.H9)(e,b.id),{votes:0,voterIds:[]});a.update(b,{round:(0,g.GV)(1),expiresAt:g.Dc.fromMillis(Date.now()+3e4),contestantCount:d.length})}}});let a=await (0,g.x7)(b);if(a.exists()){let b=a.data();b?.status==="finished"&&b.winner&&await k(b.winner.ownerId)}}catch(c){console.error(`Failed to process state for session ${a}:`,c);try{await (0,g.mZ)(b,{status:"finished",error:c.message})}catch(b){console.error(`Failed to even mark session ${a} as finished:`,b)}}}(0,j.registerClientReference)(function(){throw Error("Attempted to call MAX_DRAWS() from the server but MAX_DRAWS is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"/home/user/studio/src/lib/draw-manager.ts","MAX_DRAWS"),(0,j.registerClientReference)(function(){throw Error("Attempted to call refillDraws() from the server but refillDraws is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"/home/user/studio/src/lib/draw-manager.ts","refillDraws"),(0,j.registerClientReference)(function(){throw Error("Attempted to call useDraw() from the server but useDraw is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"/home/user/studio/src/lib/draw-manager.ts","useDraw"),(0,j.registerClientReference)(function(){throw Error("Attempted to call refundDraw() from the server but refundDraw is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"/home/user/studio/src/lib/draw-manager.ts","refundDraw"),(0,j.registerClientReference)(function(){throw Error("Attempted to call hasClaimedDailyDraw() from the server but hasClaimedDailyDraw is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"/home/user/studio/src/lib/draw-manager.ts","hasClaimedDailyDraw"),(0,j.registerClientReference)(function(){throw Error("Attempted to call claimFreeDraw() from the server but claimFreeDraw is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"/home/user/studio/src/lib/draw-manager.ts","claimFreeDraw"),(0,c(40410).D)([l,m,n,o,p,q,r,s]),(0,d.A)(l,"60b12aab991d43180e8e67b5b5f93f1346e524b4d6",null),(0,d.A)(m,"00b166d64f15316511da8f7dd4422c78f9eeecd41b",null),(0,d.A)(n,"006f03c26a91e8230ee43c7858e57087338a37e4ac",null),(0,d.A)(o,"706f3b3e02c029cb03e5a6dcee30486c0b2e9a1e5b",null),(0,d.A)(p,"78a218c5b1d991013d1ca19cbaebb93a4dd91cfdb4",null),(0,d.A)(q,"709328934fb34b0e3b0b8e87707fbfa741f4638731",null),(0,d.A)(r,"605f9838793076e9870ca01e21d9376b0715394958",null),(0,d.A)(s,"404727f97cf64239d80ee3a9f54c6de6322c7f33a7",null);var t=c(24176)}};