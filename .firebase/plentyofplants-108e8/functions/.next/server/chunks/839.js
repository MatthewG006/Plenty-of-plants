"use strict";exports.id=839,exports.ids=[839],exports.modules={11220:(a,b,c)=>{c.r(b),c.d(b,{"0093af131250d7e6ad2e4049d028fc90c8dcbaf3a8":()=>m,"009d9a32772cdb888b206c4cd6e907f985be380bf9":()=>n,"402da768e7a41e8682ec7fcd10fc2d1efbae22aa75":()=>s,"403eb5c0556de52d9f37ed8c3f7f27e11decb78a1a":()=>t.o,"60b6c56b0e23a3987ee19f8431fc5635b22e11088d":()=>r,"70ecf2fa33444e20ade17fdb1c17b64129d0cfa489":()=>o,"70f2627d27e17bbaac379e1b07880dda3750059970":()=>q,"78ef475e9e106756b988199bd95fc296a0343cee24":()=>p});var d=c(91488);c(27806);var e=c(53849),f=c(54409),g=c(96616),h=c(83770);let i=(0,e.Dk)().length?(0,e.Sx)():(0,e.Wp)({apiKey:"AIzaSyBxgn4A1fMUdIwUKdDh4KWyjJTSle2dXQE",authDomain:"plentyofplants-108e8.firebaseapp.com",projectId:"plentyofplants-108e8",storageBucket:"plentyofplants-108e8.appspot.com",messagingSenderId:"317861154450",appId:"1:317861154450:web:3a586f3cc5b1c42e64e04b"});(0,f.xI)(i);let j=(0,g.aU)(i);(0,h.c7)(i);var k=c(83183);async function l(a){let b=(0,g.H9)(j,"users",a);await (0,g.mZ)(b,{redGlitterCount:(0,g.GV)(1),gold:(0,g.GV)(50)})}async function m(){let a=g.Dc.now(),b=(0,g.rJ)(j,"contestSessions"),c=(0,g.P)(b,(0,g._M)("status","==","waiting"),(0,g._M)("expiresAt","<=",a)),d=(0,g.P)(b,(0,g._M)("status","==","voting"),(0,g._M)("expiresAt","<=",a));try{let[a,b]=await Promise.all([(0,g.GG)(c),(0,g.GG)(d)]);for(let c of[...a.docs,...b.docs])await s(c.id)}catch(a){console.error("Error during contest cleanup:",a)}}async function n(){let a=(0,g.rJ)(j,"contestSessions"),b=(0,g.P)(a,(0,g._M)("status","==","waiting"));return(await (0,g.GG)(b)).docs.map(a=>{let b=a.data(),c=b.createdAt,d=b.expiresAt;return{id:a.id,...b,createdAt:c?.toDate?c.toDate().toISOString():c,expiresAt:d?.toDate?d.toDate().toISOString():d}})}async function o(a,b,c){try{if(!c)throw Error("A valid plant must be provided to create a contest.");return{sessionId:await (0,g.c4)(j,async d=>{let e=(0,g.H9)((0,g.rJ)(j,"contestSessions")),f={status:"waiting",createdAt:(0,g.O5)(),expiresAt:g.Dc.fromMillis(Date.now()+18e4),round:1,contestantCount:1,hostName:b};d.set(e,f);let h=(0,g.H9)((0,g.rJ)(e,"contestants")),{id:i,...k}=c,l={...k,id:h.id,ownerId:a,ownerName:b,votes:0,voterIds:[],lastSeen:g.Dc.now()};return d.set(h,l),e.id})}}catch(a){return console.error("Error creating new contest:",a),{error:a.message||"An unknown error occurred while creating the contest."}}}async function p(a,b,c,d){try{return await (0,g.c4)(j,async e=>{let f=(0,g.H9)(j,"contestSessions",a),h=await e.get(f);if(!h.exists()||"waiting"!==h.data().status)throw Error("This contest is no longer accepting new players.");if(h.data().contestantCount>=4)throw Error("This contest lobby is full.");let i=(0,g.rJ)(f,"contestants"),k=(0,g.P)(i,(0,g._M)("ownerId","==",b)),l=await (0,g.GG)(k);if(!l.empty&&!l.docs.some(b=>b.ref.parent.parent?.id!==a))throw Error("You have already entered this contest.");let m=(0,g.H9)(i),{id:n,...o}=d,p={...o,id:m.id,ownerId:b,ownerName:c,votes:0,voterIds:[],lastSeen:g.Dc.now()};e.set(m,p),e.update(f,{contestantCount:(0,g.GV)(1)})}),{success:!0}}catch(a){return console.error("Error joining contest:",a),{success:!1,error:a.message||"Failed to join contest."}}}async function q(a,b,c){try{return await (0,g.c4)(j,async d=>{let e=(0,g.H9)(j,"contestSessions",a),f=(0,g.H9)(e,"contestants",c),h=await d.get(e);if(!h.exists()||"voting"!==h.data().status)throw Error("Voting for this contest has ended.");let i=(0,g.rJ)(e,"contestants");if((await d.get((0,g.P)(i))).docs.map(a=>a.data()).some(a=>a.voterIds?.includes(b)))throw Error("You have already voted in this round.");let k=await d.get(f);if(!k.exists())throw Error("This contestant is no longer in the running.");if(k.data().ownerId===b)throw Error("You cannot vote for your own plant.");d.update(f,{votes:(0,g.GV)(1),voterIds:(0,g.hq)(b)})}),{success:!0}}catch(a){return console.error("Error casting vote:",a),{success:!1,error:a.message||"Failed to cast vote."}}}async function r(a,b){let c=(0,g.rJ)(j,"contestSessions",a,"contestants"),d=(0,g.P)(c,(0,g._M)("ownerId","==",b));try{let a=await (0,g.GG)(d);if(!a.empty){let b=a.docs[0];await (0,g.mZ)(b.ref,{lastSeen:g.Dc.now()})}}catch(a){console.error("Error sending heartbeat:",a)}}async function s(a){let b=(0,g.H9)(j,"contestSessions",a);try{await (0,g.c4)(j,async a=>{let c=await a.get(b);if(!c.exists())throw Error("Session not found.");let d=c.data();if("finished"===d.status)return;let e=(0,g.rJ)(b,"contestants"),f=(await a.get((0,g.P)(e))).docs.map(a=>({...a.data(),id:a.id}));if("waiting"===d.status){let c=g.Dc.now().seconds,d=f.filter(a=>c-(a.lastSeen?.seconds||0)<30);if(d.length<f.length){for(let b of f.filter(a=>!d.find(b=>b.id===a.id)))a.delete((0,g.H9)(e,b.id));a.update(b,{contestantCount:d.length})}if(d.length<2)return void a.update(b,{status:"finished",winner:null});a.update(b,{status:"voting",expiresAt:g.Dc.fromMillis(Date.now()+3e4)})}else if("voting"===d.status){if(0===f.length)return void a.update(b,{status:"finished",winner:null});let c=Math.max(...f.map(a=>a.votes||0),0),d=f.filter(a=>(a.votes||0)===c);if(1===d.length&&f.length>1){let c=d[0];a.update(b,{status:"finished",winner:c})}else{for(let b of f.filter(a=>(a.votes||0)<c))a.delete((0,g.H9)(e,b.id));for(let b of((0,g.wP)(j),d))a.update((0,g.H9)(e,b.id),{votes:0,voterIds:[]});a.update(b,{round:(0,g.GV)(1),expiresAt:g.Dc.fromMillis(Date.now()+3e4),contestantCount:d.length})}}});let a=await (0,g.x7)(b);if(a.exists()){let b=a.data();b?.status==="finished"&&b.winner&&await l(b.winner.ownerId)}}catch(c){console.error(`Failed to process state for session ${a}:`,c);try{await (0,g.mZ)(b,{status:"finished"})}catch(b){console.error(`Failed to even mark session ${a} as finished:`,b)}}}(0,k.registerClientReference)(function(){throw Error("Attempted to call MAX_DRAWS() from the server but MAX_DRAWS is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"/home/user/studio/src/lib/draw-manager.ts","MAX_DRAWS"),(0,k.registerClientReference)(function(){throw Error("Attempted to call refillDraws() from the server but refillDraws is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"/home/user/studio/src/lib/draw-manager.ts","refillDraws"),(0,k.registerClientReference)(function(){throw Error("Attempted to call useDraw() from the server but useDraw is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"/home/user/studio/src/lib/draw-manager.ts","useDraw"),(0,k.registerClientReference)(function(){throw Error("Attempted to call refundDraw() from the server but refundDraw is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"/home/user/studio/src/lib/draw-manager.ts","refundDraw"),(0,k.registerClientReference)(function(){throw Error("Attempted to call hasClaimedDailyDraw() from the server but hasClaimedDailyDraw is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"/home/user/studio/src/lib/draw-manager.ts","hasClaimedDailyDraw"),(0,k.registerClientReference)(function(){throw Error("Attempted to call claimFreeDraw() from the server but claimFreeDraw is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"/home/user/studio/src/lib/draw-manager.ts","claimFreeDraw"),(0,c(40410).D)([m,n,o,p,q,r,s]),(0,d.A)(m,"0093af131250d7e6ad2e4049d028fc90c8dcbaf3a8",null),(0,d.A)(n,"009d9a32772cdb888b206c4cd6e907f985be380bf9",null),(0,d.A)(o,"70ecf2fa33444e20ade17fdb1c17b64129d0cfa489",null),(0,d.A)(p,"78ef475e9e106756b988199bd95fc296a0343cee24",null),(0,d.A)(q,"70f2627d27e17bbaac379e1b07880dda3750059970",null),(0,d.A)(r,"60b6c56b0e23a3987ee19f8431fc5635b22e11088d",null),(0,d.A)(s,"402da768e7a41e8682ec7fcd10fc2d1efbae22aa75",null);var t=c(24176)}};